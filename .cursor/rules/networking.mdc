---
alwaysApply: true
---
# Networking (Dio)

## Dio 설정
```dart
@Riverpod(keepAlive: true)
Dio dio(DioRef ref) {
  final dio = Dio(BaseOptions(
    baseUrl: Env.apiUrl,
    connectTimeout: const Duration(seconds: 30),
    receiveTimeout: const Duration(seconds: 30),
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
    },
  ));
  
  // Interceptor 추가
  dio.interceptors.add(LogInterceptor(responseBody: true));
  dio.interceptors.add(AuthInterceptor(ref));
  
  return dio;
}
```

## BaseResponse 패턴
```dart
@freezed
class BaseResponse<T> with _$BaseResponse<T> {
  const factory BaseResponse({
    required int status,
    required String message,
    T? data,
  }) = _BaseResponse;
  
  factory BaseResponse.fromJson(
    Map<String, dynamic> json,
    T Function(Object?) fromJsonT,
  ) => _$BaseResponseFromJson(json, fromJsonT);
}
```

## Error Handling
```dart
// core/error/failures.dart
@freezed
class Failure with _$Failure {
  const factory Failure.serverError(String message) = ServerFailure;
  const factory Failure.networkError() = NetworkFailure;
  const factory Failure.unauthorizedError() = UnauthorizedFailure;
  const factory Failure.notFoundError() = NotFoundFailure;
  const factory Failure.unknownError(String message) = UnknownFailure;
}

// Repository에서 DioException → Failure 변환
try {
  final response = await _dio.get('/trainers');
  return Right(TrainerListModel.fromJson(response.data));
} on DioException catch (e) {
  if (e.type == DioExceptionType.connectionTimeout) {
    return const Left(Failure.networkError());
  } else if (e.response?.statusCode == 401) {
    return const Left(Failure.unauthorizedError());
  }
  return Left(Failure.serverError(e.message ?? 'Unknown error'));
}
```

## Token Refresh Interceptor
```dart
class AuthInterceptor extends Interceptor {
  final Ref ref;
  
  AuthInterceptor(this.ref);
  
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) async {
    final token = await ref.read(authRepositoryProvider).getToken();
    if (token != null) {
      options.headers['Authorization'] = 'Bearer $token';
    }
    handler.next(options);
  }
  
  @override
  void onError(DioException err, ErrorInterceptorHandler handler) async {
    if (err.response?.statusCode == 401) {
      // Token refresh 로직
      final newToken = await ref.read(authRepositoryProvider).refreshToken();
      if (newToken != null) {
        err.requestOptions.headers['Authorization'] = 'Bearer $newToken';
        final response = await _dio.fetch(err.requestOptions);
        return handler.resolve(response);
      }
    }
    handler.next(err);
  }
}
```
